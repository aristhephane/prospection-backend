# Frontend configuration
<VirtualHost *:80>
    ServerName upjv-prospection-vps.amourfoot.fr
    DocumentRoot /var/www/html/prospection-frontend/build

    # Redirection vers HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

    # Configuration pour le frontend (React)
    <Directory /var/www/html/prospection-frontend/build>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # Toutes les requêtes non-fichiers sont routées vers index.html (SPA)
        <IfModule mod_rewrite.c>
            RewriteEngine On
            RewriteBase /
            RewriteRule ^index\.html$ - [L]
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteRule . /index.html [L]
        </IfModule>
        
        # Désactiver le cache pour résoudre les problèmes de mise à jour
        <FilesMatch "\.(html|js|css)$">
            Header set Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
            Header set Pragma "no-cache"
            Header set Expires "Wed, 11 Jan 1984 05:00:00 GMT"
        </FilesMatch>
    </Directory>

    # Configuration pour le backend (API) - servir via /api
    Alias /api /var/www/html/prospection-backend/public
    <Directory /var/www/html/prospection-backend/public>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        <IfModule mod_rewrite.c>
            RewriteEngine On
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteRule ^(.*)$ index.php [QSA,L]
        </IfModule>
        
        # Configuration CORS sécurisée
        <IfModule mod_headers.c>
            # Limiter aux origines spécifiques
            SetEnvIf Origin "^https://upjv-prospection-vps\.amourfoot\.fr(|:3000)$" ALLOWED_ORIGIN=$0
            Header always set Access-Control-Allow-Origin "%{ALLOWED_ORIGIN}e" env=ALLOWED_ORIGIN
            Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
            Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
            Header always set Access-Control-Expose-Headers "Authorization"
            Header always set Access-Control-Allow-Credentials "true"
            Header always set Access-Control-Max-Age "3600"
            
            # Gérer les requêtes OPTIONS
            RewriteEngine On
            RewriteCond %{REQUEST_METHOD} OPTIONS
            RewriteRule ^(.*)$ $1 [R=200,L]
        </IfModule>
    </Directory>

    # Logs avec niveau de détail augmenté pour le débogage
    ErrorLog /var/log/httpd/prospection-error.log
    CustomLog /var/log/httpd/prospection-access.log combined
    LogLevel debug
</VirtualHost>

<VirtualHost *:443>
    ServerName upjv-prospection-vps.amourfoot.fr
    DocumentRoot /var/www/html/prospection-frontend/build

    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/upjv-prospection-vps.amourfoot.fr/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/upjv-prospection-vps.amourfoot.fr/privkey.pem

    # Configuration additionnelle de sécurité SSL/TLS
    SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite HIGH:!aNULL:!MD5:!3DES
    SSLHonorCipherOrder on
    Header always set Strict-Transport-Security "max-age=31536000"

    # Configuration pour le frontend (React)
    <Directory /var/www/html/prospection-frontend/build>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # Toutes les requêtes non-fichiers sont routées vers index.html (SPA)
        <IfModule mod_rewrite.c>
            RewriteEngine On
            RewriteBase /
            RewriteRule ^index\.html$ - [L]
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteRule . /index.html [L]
        </IfModule>
        
        # En-têtes de sécurité pour le frontend
        <IfModule mod_headers.c>
            Header set X-Content-Type-Options "nosniff"
            Header set X-XSS-Protection "1; mode=block"
            Header set X-Frame-Options "SAMEORIGIN"
            Header set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self' data:; connect-src 'self' https://upjv-prospection-vps.amourfoot.fr;"
            Header set Referrer-Policy "strict-origin-when-cross-origin"
            
            # Désactiver le cache pour résoudre les problèmes de mise à jour
            <FilesMatch "\.(html|js|css)$">
                Header set Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
                Header set Pragma "no-cache"
                Header set Expires "Wed, 11 Jan 1984 05:00:00 GMT"
            </FilesMatch>
        </IfModule>
    </Directory>

    # Configuration pour le backend (API) - servir via /api
    Alias /api /var/www/html/prospection-backend/public
    <Directory /var/www/html/prospection-backend/public>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        <IfModule mod_rewrite.c>
            RewriteEngine On
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteRule ^(.*)$ index.php [QSA,L]
        </IfModule>
        
        # Configuration CORS sécurisée
        <IfModule mod_headers.c>
            # Limiter aux origines spécifiques
            SetEnvIf Origin "^https://upjv-prospection-vps\.amourfoot\.fr(|:3000)$" ALLOWED_ORIGIN=$0
            Header always set Access-Control-Allow-Origin "%{ALLOWED_ORIGIN}e" env=ALLOWED_ORIGIN
            Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
            Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
            Header always set Access-Control-Expose-Headers "Authorization"
            Header always set Access-Control-Allow-Credentials "true"
            Header always set Access-Control-Max-Age "3600"
            
            # Gérer les requêtes OPTIONS
            RewriteEngine On
            RewriteCond %{REQUEST_METHOD} OPTIONS
            RewriteRule ^(.*)$ $1 [R=200,L]
        </IfModule>
    </Directory>

    # Logs
    ErrorLog /var/log/httpd/prospection-ssl-error.log
    CustomLog /var/log/httpd/prospection-ssl-access.log combined
    LogLevel debug
</VirtualHost>

